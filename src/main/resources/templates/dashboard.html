<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">Expense Planner</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link active" th:href="@{/dashboard}">Dashboard</a>
            <a class="nav-link" th:href="@{/accounts}">Accounts</a>
            <a class="nav-link" th:href="@{/transactions}">Transactions</a>
            <a class="nav-link" th:href="@{/budget}">Budgets</a>
            <a class="nav-link" th:href="@{/transfer}">Transfer</a>
            <a class="nav-link" th:href="@{/user/profile}">Profile</a>
            <a class="nav-link" th:href="@{/logout}">Logout</a>
        </div>
    </div>
</nav>
<div class="container">
    <h2>Welcome, <span th:text="${user != null ? user.firstName : 'User'}">User</span>!</h2>
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-bg-success mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">Total Balance</h5>
                    <p class="card-text fs-4" th:text="${totalBalance != null ? totalBalance : 0.0}">0.0</p>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <canvas id="balanceChart" height="60"></canvas>
        </div>
    </div>
    <h4 class="mt-4">Recent Transactions</h4>
    <table class="table table-striped table-hover shadow-sm">
        <thead>
        <tr>
            <th>Date</th><th>Description</th><th>Category</th><th>Amount</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="t : ${recentTransactions}">
            <td th:text="${t.date}"></td>
            <td th:text="${t.description}"></td>
            <td th:text="${t.category}"></td>
            <td th:text="${t.amount}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(recentTransactions)}">
            <td colspan="4" class="text-center">No transactions yet.</td>
        </tr>
        </tbody>
    </table>
    <h4 class="mt-4">Budgets</h4>
    <div class="row">
        <div class="col-md-4" th:each="b : ${budgets}">
            <div class="card mb-3 shadow">
                <div class="card-header">
                    <span th:text="${b.category}"></span>
                </div>
                <div class="card-body">
                    <div class="progress">
                        <div class="progress-bar"
                             role="progressbar"
                             th:style="'width:' + (${b.spent}/${b.amount}*100) + '%;'"
                             th:text="${#numbers.formatDecimal(b.spent/b.amount*100, 0, 0)} + '%'"></div>
                    </div>
                    <p class="mt-2">Spent: <span th:text="${b.spent}"></span> / <span th:text="${b.amount}"></span></p>
                </div>
            </div>
        </div>
        <div class="col-12" th:if="${#lists.isEmpty(budgets)}">
            <p class="text-muted text-center">No budgets set yet.</p>
        </div>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
        var accountNames = [
            /*[# th:each="a, aStat : ${accounts}"]*/
                /*[['${a.name}']]*/[[${aStat.last ? '' : ','}]]
            /*[/]*/
        ];
        var accountBalances = [
            /*[# th:each="a, aStat : ${accounts}"]*/
                [[${a.balance}]] [[${aStat.last ? '' : ','}]]
            /*[/]*/
        ];
        var ctx = document.getElementById('balanceChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: accountNames,
                datasets: [{
                    label: 'Account Balances',
                    data: accountBalances,
                    backgroundColor: 'rgba(54,162,235,0.5)'
                }]
            }
        });
    /*]]>*/
</script>
</body>
</html>
